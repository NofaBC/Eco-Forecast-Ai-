<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EcoForecast AI™ — Event-to-Economy Forecaster</title>
  <meta name="description" content="Forecast the local economic impact of wars, market shocks, weather, regime changes, and new policies on cities and businesses." />
  <style>
    :root { --bg:#0b1020; --card:#121a35; --edge:#1c254b; --text:#e8ecff; --muted:#aab3d9; --accent:#6ea8fe; --good:#35c759; --bad:#ff453a; --warn:#ffd60a; }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial;background:linear-gradient(180deg,#0b1020,#0a0f1c);color:var(--text)}
    a{color:var(--accent); text-decoration:none}
    header{padding:28px 20px;border-bottom:1px solid var(--edge);background:rgba(10,15,28,.6);backdrop-filter:saturate(1.2) blur(8px);position:sticky;top:0;z-index:20}
    .wrap{max-width:1080px;margin:0 auto}
    .flex{display:flex;gap:14px;align-items:center;justify-content:space-between}
    h1{margin:0;font-size:22px;letter-spacing:.3px}
    .tag{display:inline-block;margin-top:8px;padding:4px 10px;border:1px solid #263064;border-radius:999px;color:var(--muted);font-size:12px}
    main{padding:26px 20px}

    /* Hero */
    .hero{display:grid;grid-template-columns:1.1fr .9fr;gap:20px;margin-bottom:18px}
    .hero-card{background:var(--card);border:1px solid var(--edge);border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .hero h2{margin:0 0 10px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid #2a3567;color:var(--muted);font-size:12px}

    /* Form */
    label{display:block;font-size:13px;color:var(--muted);margin:10px 0 4px}
    input,select,textarea{width:100%;padding:12px 12px;border-radius:12px;border:1px solid #27315f;background:#0e1530;color:var(--text);outline:none}
    textarea{min-height:100px;resize:vertical}
    button{padding:14px 16px;border-radius:12px;border:1px solid #33407a;background:linear-gradient(180deg,#2741b3,#1f2d80);color:white;font-weight:600;cursor:pointer}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .chip{border:1px solid #2a3567;background:#0e1530;padding:6px 10px;border-radius:999px;font-size:12px;cursor:pointer}

    /* Results */
    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:8px}
    .kpi .v{font-size:22px;font-weight:700}
    .kpi .u{font-size:12px;color:var(--muted)}
    .drivers{list-style:none;padding:0;margin:0}
    .drivers li{margin:6px 0}
    .good{color:var(--good)} .bad{color:var(--bad)} .warn{color:var(--warn)}
    .src-badge{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--edge);border-radius:999px;padding:4px 10px;font-size:11px;color:var(--muted);margin-top:10px}
    .result-actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}

    /* Pricing */
    .pricing{margin-top:32px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
    .card{background:var(--card);border:1px solid var(--edge);border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.25)}

    /* Pricing table */
    .nofa-pricing{background:linear-gradient(180deg,#0b1020,#0a0f1c);color:var(--text);padding:8px 0}
    .nofa-wrap{max-width:1100px;margin:0 auto}
    .nofa-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:18px}
    .nofa-card{background:var(--card);border:1px solid var(--edge);border-radius:16px;padding:20px;display:flex;flex-direction:column;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .nofa-badge{display:inline-flex;gap:6px;align-items:center;font-size:12px;color:var(--muted);border:1px solid var(--edge);border-radius:999px;padding:4px 10px;margin-bottom:10px}
    .nofa-title{font-size:18px;font-weight:700;margin:0 0 6px}
    .nofa-sub{font-size:13px;color:var(--muted);margin:0 0 12px}
    .nofa-price{display:flex;align-items:flex-end;gap:6px;margin:6px 0 12px}
    .nofa-price .amt{font-size:28px;font-weight:800}
    .nofa-price .unit{font-size:13px;color:var(--muted)}
    .nofa-setup{font-size:12px;color:var(--warn);margin:-4px 0 10px}
    .nofa-cta{margin-top:auto;display:flex;flex-direction:column;gap:10px}
    .nofa-cta a{display:inline-block;text-align:center;color:white;font-weight:700;padding:12px 14px;border-radius:12px;border:1px solid #32407a;background:linear-gradient(180deg,#2741b3,#1f2d80)}
    .nofa-cta a.secondary{background:#0f1630}
    .nofa-features{list-style:none;padding:0;margin:12px 0 0;display:grid;gap:8px;font-size:14px}
    .strike{color:var(--muted);text-decoration:line-through}
    .save-tag{font-size:11px;color:var(--good);border:1px solid rgba(53,199,89,.35);border-radius:999px;padding:2px 8px;margin-left:6px}
    .toggleRow{display:flex;align-items:center;gap:10px;margin:10px 0 20px;color:var(--muted);font-size:13px}
    .switch{position:relative;width:48px;height:26px;background:#0f1630;border:1px solid var(--edge);border-radius:999px;cursor:pointer}
    .switch i{position:absolute;top:2px;left:2px;width:20px;height:20px;border-radius:50%;background:var(--accent);transition:transform .2s}
    input#billing:checked + .switch i{transform:translateX(22px)}

    .badge-available, .badge-soon { display:inline-flex; align-items:center; gap:6px; font-size:11px; padding:3px 8px; border-radius:999px; border:1px solid var(--edge); }
    .badge-available { color: var(--good); border-color: rgba(53,199,89,.5); }
    .badge-soon { color: var(--warn); border-color: rgba(255,214,10,.45); }
    .avail.live { color: var(--good); }
    .avail.soon { color: var(--warn); }
    .cta-disabled { opacity:.6; cursor:not-allowed; }

    /* Account dropdown */
    .account{position:relative; display:inline-block}
    .account-btn{cursor:pointer; padding:8px 10px; border:1px solid var(--edge); border-radius:10px; color:var(--text); background:#0f1630;}
    .account-menu{position:absolute; right:0; top:42px; min-width:260px; display:none; background:var(--card); border:1px solid var(--edge); border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.35); padding:6px}
    .account-menu.open{display:block}
    .account-menu a, .account-menu button{display:block; width:100%; text-align:left; background:transparent; border:0; color:var(--text); padding:10px 12px; border-radius:8px; cursor:pointer}
    .account-menu a:hover, .account-menu button:hover{background:#0f1630}
    .usage{padding:8px 12px; color:var(--muted); font-size:12px}

    /* History modal */
    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.5); z-index:50}
    .modal.open{display:flex}
    .modal-card{width:min(720px,92vw); max-height:80vh; overflow:auto; background:var(--card); border:1px solid var(--edge); border-radius:16px; padding:16px}
    .modal-card h3{margin:0 0 8px}
    .hist-item{padding:10px 0; border-bottom:1px dashed #27315f; font-size:14px}
    .hist-item:last-child{border-bottom:none}

    @media (max-width:980px){
      .hero{grid-template-columns:1fr}
      .grid{grid-template-columns:1fr}
      .nofa-grid{grid-template-columns:1fr}
    }

    /* Print styles for PDF brief */
    @media print {
      header, footer, nav, .modal { display:none !important; }
      body { background:#fff; color:#000; }
      .hero-card { border:0; box-shadow:none; }
      a { color:#000; }
    }
  </style>

  <!-- Firebase (compat builds) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics-compat.js"></script>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="flex">
        <div>
          <h1>EcoForecast AI™</h1>
          <div class="tag">Turn events into city & business forecasts — in seconds</div>
        </div>
        <nav aria-label="top">
          <a href="#forecast">Forecast</a>
          &nbsp;·&nbsp;
          <a href="#pricing">Pricing</a>
          &nbsp;·&nbsp;
          <!-- Account -->
          <span class="account">
            <button id="accountBtn" class="account-btn">Sign In</button>
            <div id="accountMenu" class="account-menu" role="menu" aria-label="Account menu"></div>
          </span>
        </nav>
      </div>
    </div>
  </header>

  <main class="wrap" id="forecast">
    <section class="hero">
      <!-- Left: Form -->
      <section class="hero-card" aria-labelledby="form-title">
        <h2 id="form-title">Forecast an Impact</h2>
        <p class="pill">Step 1 · Describe the event or paste a bill / EO summary</p>

        <label for="event">Event / Policy</label>
        <textarea id="event" placeholder="Example: 'U.S. imposes 10% tariff on aluminum; expected start in 60 days' OR paste a bill/EO text."></textarea>

        <div class="chips" aria-label="Event presets">
          <button class="chip" data-preset="war_escalation">War Escalation</button>
          <button class="chip" data-preset="tariff_steel">10% Steel Tariff</button>
          <button class="chip" data-preset="hurricane_landfall">Hurricane Landfall</button>
          <button class="chip" data-preset="regime_change">Regime Change</button>
          <button class="chip" data-preset="party_shift_us">US Party Shift</button>
        </div>

        <div class="row">
          <div>
            <label for="geo">City / Region</label>
            <input id="geo" placeholder="e.g., Potomac, MD or Phoenix, AZ" list="geo-suggest" />
            <datalist id="geo-suggest">
              <option value="Phoenix, AZ"></option>
              <option value="Potomac, MD"></option>
              <option value="New York, NY"></option>
              <option value="Miami, FL"></option>
              <option value="Houston, TX"></option>
            </datalist>
          </div>
          <div>
            <label for="naics">Industry (NAICS or keyword)</label>
            <input id="naics" placeholder="e.g., 7225 (Restaurants) or 'Homebuilding'" list="naics-suggest" />
            <datalist id="naics-suggest">
              <option value="7225 — Restaurants"></option>
              <option value="2361 — Residential Building Construction"></option>
              <option value="3364 — Aerospace Product & Parts"></option>
              <option value="4238 — Machinery, Equipment & Supplies Wholesalers"></option>
              <option value="6211 — Offices of Physicians"></option>
            </datalist>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="horizon">Horizon</label>
            <select id="horizon">
              <option value="short">0–3 months</option>
              <option value="medium" selected>3–12 months</option>
              <option value="long">12–24 months</option>
            </select>
          </div>
          <div>
            <label for="scenario">Scenario</label>
            <select id="scenario">
              <option>Base</option>
              <option>Best Case</option>
              <option>Severe</option>
            </select>
          </div>
        </div>

        <label for="factors">(Optional) Extra factors to include</label>
        <input id="factors" placeholder="wars, stock volatility, weather alerts, regime changes, party control…" />

        <div style="margin-top:14px;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <button id="run">Run Forecast</button>
          <button id="reset" class="secondary" style="background:#0f1630;border:1px solid var(--edge);color:var(--text)">Reset</button>
          <span id="status" style="color:var(--muted)"></span>
        </div>
      </section>

      <!-- Right: Results -->
      <section class="hero-card" aria-labelledby="results-title">
        <h2 id="results-title">Results</h2>
        <div id="results" style="min-height:260px">
          <p class="pill">Your forecast will appear here with drivers & confidence.</p>
          <div class="kpi" aria-live="polite">
            <div><div class="u">Demand</div><div id="kpiDemand" class="v">—</div></div>
            <div><div class="u">Costs</div><div id="kpiCosts" class="v">—</div></div>
            <div><div class="u">EBITDA Margin</div><div id="kpiMargin" class="v">—</div></div>
          </div>
          <h3 style="margin:14px 0 6px">Top Drivers</h3>
          <ul id="drivers" class="drivers"></ul>
          <p id="conf" class="u" style="margin-top:8px"></p>
          <div id="sourceBadge" class="src-badge" style="display:none"></div>

          <!-- Show more details -->
          <div id="moreSwitch" style="margin-top:10px">
            <label style="font-size:12px;color:var(--muted);display:flex;gap:8px;align-items:center">
              <input type="checkbox" id="showMore">
              Show more details
            </label>
          </div>

          <div id="details" style="display:none; margin-top:10px">
            <p id="sum" style="margin:6px 0"></p>
            <h4 style="margin:10px 0 4px">Assumptions</h4>
            <ul id="assumptions" class="drivers"></ul>
            <h4 style="margin:10px 0 4px">Risks</h4>
            <ul id="risks" class="drivers"></ul>
            <h4 style="margin:10px 0 4px">Local Signals</h4>
            <ul id="signals" class="drivers"></ul>
            <h4 style="margin:10px 0 4px">Time Path</h4>
            <ul id="tpath" class="drivers"></ul>
            <h4 style="margin:10px 0 4px">Suggested Actions</h4>
            <ul id="actions" class="drivers"></ul>
          </div>

          <!-- Impact Chart -->
          <h4 style="margin:12px 0 6px">Impact Visual</h4>
          <canvas id="chartImpact" width="560" height="220" style="width:100%;max-width:100%;border:1px solid var(--edge);border-radius:10px;background:#0e1530"></canvas>
          <p class="u" id="chartNote" style="margin-top:6px"></p>

          <!-- Result Actions -->
          <div class="result-actions">
            <button id="btnCsv">Download CSV</button>
            <button id="btnPdf">Download PDF Brief</button>
          </div>
        </div>
      </section>
    </section>

    <!-- Pricing Section -->
    <section id="pricing" class="pricing" aria-labelledby="pricing-title">
      <h2 id="pricing-title" style="margin:0 0 12px">Pricing & Onboarding</h2>
      <section class="nofa-pricing" aria-labelledby="pricing-h">
        <div class="nofa-wrap">
          <h3 id="pricing-h" class="nofa-sub" style="margin:0 0 8px">EcoForecast AI™ Plans</h3>

          <p class="nofa-sub" style="margin:6px 0 14px">
            <strong>Note:</strong> We’re in <em>Demo+</em>. <span class="avail live">Business Insight is available now</span>.
            <span class="avail soon">Analyst Pro</span> and <span class="avail soon">Enterprise</span> are coming soon.
          </p>

          <label class="toggleRow" for="billing">
            <span>Bill monthly</span>
            <input id="billing" type="checkbox" hidden>
            <span class="switch" aria-hidden="true"><i></i></span>
            <span>Bill annually <span class="save-tag">save ~15% + setup waivers*</span></span>
          </label>

          <div class="nofa-grid" role="list">
            <!-- Business Insight -->
            <article class="nofa-card" role="listitem" aria-label="Business Insight plan">
              <span class="nofa-badge">EcoForecast AI™</span>
              <h4 class="nofa-title">Business Insight</h4>
              <p class="nofa-sub">Localized forecasts for SMBs (city + industry).</p>
              <div class="nofa-price"><span class="amt" data-month="$197/mo" data-annual="$167/mo">$197/mo</span><span class="unit">USD</span></div>
              <div class="nofa-setup">Setup: <strong>Optional $250</strong> (waived on annual)</div>
              <p><span class="badge-available">Available Now</span></p>
              <ul class="nofa-features">
                <li>10 forecasts/month</li>
                <li>Drivers & confidence</li>
                <li>Downloadable briefs</li>
                <li class="strike">Scenario Studio</li>
              </ul>
              <div class="nofa-cta">
                <a href="#" onclick="return sendEmail('info@nofabusinessconsulting.com','EcoForecast AI — Start Business Insight (beta)', T_BIZ);" aria-label="Start Business Insight (beta)">Get Started (Beta)</a>
                <a class="secondary" href="#" onclick="return sendEmail('info@nofabusinessconsulting.com','EcoForecast AI — Book a Demo', T_DEMO);" aria-label="Book a demo">Book a Demo</a>
                <a class="secondary" href="#" onclick="copyEmail('info@nofabusinessconsulting.com'); return false;" aria-label="Copy email address">Copy Email</a>
              </div>
            </article>

            <!-- Analyst Pro -->
            <article class="nofa-card" role="listitem" aria-label="Analyst Pro plan">
              <span class="nofa-badge">EcoForecast AI™</span>
              <h4 class="nofa-title">Analyst Pro</h4>
              <p class="nofa-sub">Quantified city & industry forecasts with scenarios.</p>
              <div class="nofa-price"><span class="amt" data-month="$697/mo" data-annual="$592/mo">$697/mo</span><span class="unit">USD</span></div>
              <div class="nofa-setup">Setup: <strong>$1,000</strong> (local datasets + calibration)</div>
              <p><span class="badge-soon">Coming Soon</span></p>
              <ul class="nofa-features">
                <li>Unlimited forecasts</li>
                <li>Scenario Studio (best/base/severe)</li>
                <li>Alerts (impact thresholds)</li>
                <li>City & NAICS localization</li>
              </ul>
              <div class="nofa-cta">
                <a class="secondary" href="#" onclick="return sendEmail('waitlist_ai@nofabusinessconsulting.com','Join Waitlist — Analyst Pro (please specify AI solution)', T_WAITLIST_ANALYST);" aria-label="Join waitlist for Analyst Pro">Join Waitlist</a>
                <a class="secondary" href="#" onclick="copyEmail('waitlist_ai@nofabusinessconsulting.com'); return false;" aria-label="Copy waitlist email">Copy Email</a>
                <a class="cta-disabled" aria-disabled="true" tabindex="-1" href="#" title="Purchasing opens when Analyst Pro launches">Purchase (Soon)</a>
              </div>
            </article>

            <!-- Enterprise -->
            <article class="nofa-card" role="listitem" aria-label="Enterprise plan">
              <span class="nofa-badge">EcoForecast AI™</span>
              <h4 class="nofa-title">Enterprise / Investor</h4>
              <p class="nofa-sub">Custom models, API & BI integrations, white-glove onboarding.</p>
              <div class="nofa-price"><span class="amt" data-month="$5,000+/mo" data-annual="$4,250+/mo">$5,000+/mo</span><span class="unit">USD</span></div>
              <div class="nofa-setup">Setup: <strong>$10,000</strong> (scope-dependent)</div>
              <p><span class="badge-soon">Pilot / Coming Soon</span></p>
              <ul class="nofa-features">
                <li>Custom model tuning</li>
                <li>API & data pipelines</li>
                <li>Backtesting & validation</li>
                <li>Priority support</li>
              </ul>
              <div class="nofa-cta">
                <a href="#" onclick="return sendEmail('info@nofabusinessconsulting.com','EcoForecast AI — Enterprise Pilot', T_ENTERPRISE);" aria-label="Contact sales for Enterprise pilot">Contact Sales</a>
                <a class="secondary" href="#" onclick="return sendEmail('waitlist_ai@nofabusinessconsulting.com','Join Waitlist — Enterprise (please specify AI solution)', T_WAITLIST_ANALYST);" aria-label="Join Enterprise waitlist">Join Waitlist</a>
                <a class="secondary" href="#" onclick="copyEmail('waitlist_ai@nofabusinessconsulting.com'); return false;" aria-label="Copy waitlist email">Copy Email</a>
              </div>
            </article>
          </div>
        </div>
      </section>
    </section>
  </main>

  <footer class="wrap" style="padding:28px 20px;color:var(--muted);font-size:13px">
    © EcoForecast AI™ • Part of the GovFlow AI™ family • For demo use only — not investment advice.
  </footer>

  <!-- History modal -->
  <div id="histModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="histTitle">
    <div class="modal-card">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
        <h3 id="histTitle">My Forecast History</h3>
        <button id="histClose" class="account-btn" style="padding:6px 10px">Close</button>
      </div>
      <div id="histBody"></div>
    </div>
  </div>

  <!-- Email helpers -->
  <script>
    function sendEmail(address, subject, template) {
      if (template) { (navigator.clipboard?.writeText(template).catch(()=>{})); }
      const s = encodeURIComponent(subject || '');
      window.location.href = `mailto:${address}?subject=${s}`;
      if (template) setTimeout(()=>alert('Template copied. If your mail body is empty, press Ctrl+V to paste.'), 300);
      return false;
    }
    function copyEmail(email) {
      (navigator.clipboard?.writeText(email).then(()=>alert(`Email copied: ${email}`)).catch(()=>legacyCopy(email)));
    }
    function legacyCopy(text){
      const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta);
      ta.select(); document.execCommand('copy'); document.body.removeChild(ta); alert(`Email copied: ${text}`);
    }
    const T_BIZ = ['Hi NOFA Team,','','We would like to start the Business Insight plan (EcoForecast AI).','Company:','City/Region:','Industry (NAICS):','Use cases:','Timeline:','','Thanks!'].join('\n');
    const T_DEMO = ['Hi NOFA Team,','','Please book me for a demo of EcoForecast AI.','Company:','Preferred time zones/slots:',''].join('\n');
    const T_WAITLIST_ANALYST = ['Hi NOFA Team,','','Please add me to the waitlist.','Interested AI solution: EcoForecast AI / GovFlow AI / Other (please specify)','Company:','Role:','City/Region:','Use cases:','Timeline:',''].join('\n');
    const T_ENTERPRISE = ['Hi NOFA Team,','','We’re interested in an Enterprise pilot.','Interested AI solution: EcoForecast AI / GovFlow AI / Other (please specify)','Company:','Use cases:','Integrations (BI, API, data sources):','Timeline:',''].join('\n');
  </script>

  <!-- App + Auth + History + Realtime + Chart + CSV/PDF + Usage -->
  <script>
    // ==== Firebase init (YOUR config) ====
    const firebaseConfig = {
      apiKey: "AIzaSyBBfrQcMn5Hmt2H5EbMh06LHmbCvtUZrU8",
      authDomain: "eco-forecast-ai.firebaseapp.com",
      projectId: "eco-forecast-ai",
      storageBucket: "eco-forecast-ai.firebasestorage.app",
      messagingSenderId: "133605292809",
      appId: "1:133605292809:web:681c3eb8beb4d2a506b1d8",
      measurementId: "G-XR5KV7MY16"
    };
    firebase.initializeApp(firebaseConfig);
    if (firebase.analytics) { firebase.analytics(); }

    const $ = id => document.getElementById(id);

    // ---- Account dropdown ----
    const accountBtn = $('accountBtn');
    const accountMenu = $('accountMenu');
    const histModal = $('histModal');
    const histBody = $('histBody');
    const histClose = $('histClose');

    accountBtn.addEventListener('click', () => {
      accountMenu.classList.toggle('open');
    });
    document.addEventListener('click', (e)=>{
      if (!accountMenu.contains(e.target) && !accountBtn.contains(e.target)) {
        accountMenu.classList.remove('open');
      }
    });
    histClose.addEventListener('click', ()=> histModal.classList.remove('open'));
    histModal.addEventListener('click', (e)=>{ if (e.target===histModal) histModal.classList.remove('open'); });

    async function signInWithGoogle() {
      const provider = new firebase.auth.GoogleAuthProvider();
      try {
        await firebase.auth().signInWithRedirect(provider);
      } catch (err) {
        alert('Google sign-in failed: ' + (err.message || err.code));
        console.error(err);
      }
    }
    async function signInWithEmailPrompt() {
      const email = prompt('Email:');
      if (!email) return;
      const password = prompt('Create or enter your password (min 6 chars):');
      if (!password) return;
      try {
        await firebase.auth().createUserWithEmailAndPassword(email, password);
      } catch (err) {
        if (err.code === 'auth/email-already-in-use') {
          await firebase.auth().signInWithEmailAndPassword(email, password);
        } else {
          alert('Email sign-in failed: ' + (err.message || err.code));
          console.error(err);
        }
      }
    }
    async function signOutNow(){ await firebase.auth().signOut(); }
    async function getIdToken(){
      const u = firebase.auth().currentUser;
      return u ? u.getIdToken() : null;
    }

    // Usage state
    let currentUsage = { count: 0, cap: 10 }; // cap can be plan-based later

    function renderMenu(user){
      accountMenu.innerHTML = '';
      if (!user) {
        const btnGoogle = document.createElement('button');
        btnGoogle.textContent = 'Sign in with Google';
        btnGoogle.onclick = async () => { await signInWithGoogle(); accountMenu.classList.remove('open'); };

        const btnEmail = document.createElement('button');
        btnEmail.textContent = 'Sign in with Email';
        btnEmail.onclick = async () => { await signInWithEmailPrompt(); accountMenu.classList.remove('open'); };

        accountMenu.append(btnGoogle, btnEmail);
        accountBtn.textContent = 'Sign In';
        return;
      }
      const lab = document.createElement('div');
      lab.style.cssText='padding:8px 12px;color:var(--muted);font-size:12px';
      lab.textContent = user.email;

      const usageEl = document.createElement('div');
      usageEl.className = 'usage';
      usageEl.id = 'usageView';
      usageEl.textContent = `Forecasts this month: ${currentUsage.count} / ${currentUsage.cap}`;

      const viewHist = document.createElement('button');
      viewHist.textContent = 'View Forecast History';
      viewHist.onclick = ()=>{
        accountMenu.classList.remove('open');
        histModal.classList.add('open'); // data via Firestore listener
      };

      const signOut = document.createElement('button');
      signOut.textContent = 'Sign Out';
      signOut.onclick = async ()=>{ await signOutNow(); accountMenu.classList.remove('open'); };

      accountMenu.append(lab, usageEl, viewHist, signOut);
      accountBtn.textContent = `${user.email} ▾`;
    }

    function updateUsageView(){
      const el = document.getElementById('usageView');
      if (el) el.textContent = `Forecasts this month: ${currentUsage.count} / ${currentUsage.cap}`;
    }

    // ---- Firestore (client) init ----
    const dbClient = firebase.firestore();

    // Live history state
    let unsubHistory = null;

    function attachHistoryListener(uid) {
      detachHistoryListener();
      unsubHistory = dbClient
        .collection('users').doc(uid)
        .collection('forecasts')
        .orderBy('ts', 'desc')
        .limit(50)
        .onSnapshot((snap) => {
          const items = [];
          snap.forEach(doc => {
            const x = doc.data() || {};
            const ts = x.ts && x.ts.toDate ? x.ts.toDate().toISOString() : null;
            items.push({ id: doc.id, ts, payload: x.payload || {}, result: x.result || {} });
          });
          renderHistory(items);
        }, (err) => {
          console.error('history onSnapshot error:', err);
        });
    }
    function detachHistoryListener() {
      if (typeof unsubHistory === 'function') { unsubHistory(); unsubHistory = null; }
    }

    function renderHistory(items) {
      if (!histBody) return;
      histBody.innerHTML = (items && items.length)
        ? ''
        : '<p class="nofa-sub">No history yet.</p>';

      items.forEach(it => {
        const d = tsToDate(it.ts);
        const el = document.createElement('div');
        el.className = 'hist-item';
        el.innerHTML = `
          <div style="color:var(--muted);font-size:12px">${d.toLocaleString()}</div>
          <div><strong>${esc(it?.payload?.geo||'')}</strong> · ${esc(it?.payload?.naics||'')}</div>
          <div style="color:var(--muted)">${esc((it?.payload?.event||'').slice(0,180))}</div>
        `;
        el.addEventListener('click', () => {
          hydrateFromHistory(it);
          histModal.classList.remove('open');
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });
        histBody.appendChild(el);
      });
    }

    function hydrateFromHistory(it) {
      try {
        $('event').value = it?.payload?.event || '';
        $('geo').value = it?.payload?.geo || '';
        $('naics').value = it?.payload?.naics || '';
        $('horizon').value = it?.payload?.horizon || 'medium';
        $('scenario').value = it?.payload?.scenario || 'Base';
        $('factors').value = it?.payload?.extra_factors || '';
        renderForecast(it?.result || {});
      } catch (e) {
        console.error('hydrateFromHistory error:', e);
      }
    }

    // Try to fetch usage from server, else fallback to localStorage
    async function refreshUsage(){
      const u = firebase.auth().currentUser;
      if (!u) { currentUsage = { count: 0, cap: 10 }; updateUsageView(); return; }
      const token = await u.getIdToken();
      try {
        const r = await fetch('/api/usage/get', { headers: { Authorization: `Bearer ${token}` }});
        if (!r.ok) throw new Error('no server usage');
        const j = await r.json();
        currentUsage = { count: Number(j.count || 0), cap: Number(j.cap || 10) };
      } catch {
        // Local fallback (per user per month)
        const key = usageKey(u.uid);
        const val = Number(localStorage.getItem(key) || '0');
        currentUsage = { count: val, cap: 10 };
      }
      updateUsageView();
    }

    function usageKey(uid){
      const d = new Date();
      const ym = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      return `usage:${uid}:${ym}`;
    }

    async function incrUsage(){
      const u = firebase.auth().currentUser;
      if (!u) return;
      const token = await u.getIdToken();
      try {
        const r = await fetch('/api/usage/incr', { method:'POST', headers: { Authorization: `Bearer ${token}` }});
        if (!r.ok) throw new Error('no server incr');
        const j = await r.json();
        currentUsage = { count: Number(j.count || (currentUsage.count+1)), cap: Number(j.cap || currentUsage.cap) };
      } catch {
        // localStorage fallback
        const key = usageKey(u.uid);
        const val = Number(localStorage.getItem(key) || '0') + 1;
        localStorage.setItem(key, String(val));
        currentUsage.count = val;
      }
      updateUsageView();
    }

    firebase.auth().onAuthStateChanged(async (user) => {
      renderMenu(user);
      if (user) {
        attachHistoryListener(user.uid);
        await refreshUsage();
      } else {
        detachHistoryListener();
        currentUsage = { count: 0, cap: 10 };
        updateUsageView();
      }
    });

    // ---- Forecast UI ----
    const presetsMap = {
      war_escalation: "A regional conflict escalates with partial blockade of a key shipping lane; insurance premia rise; export controls expand.",
      tariff_steel: "U.S. imposes a 10% tariff on steel imports effective in 60 days; exemptions uncertain; domestic mills signal capacity strain.",
      hurricane_landfall: "Category-4 hurricane landfall near major Gulf port; refinery throughput reduced; logistics reroutes extend lead times by 2-4 weeks.",
      regime_change: "Sudden regime change triggers capital controls and export permit reviews; FX volatility spikes; counterparties reassess risk.",
      party_shift_us: "One party gains unified control of White House and Congress; agenda prioritizes tax, energy, and labor policy changes within 12 months."
    };
    document.querySelectorAll('.chip').forEach(btn=>{
      btn.addEventListener('click',()=>{$('event').value = presetsMap[btn.getAttribute('data-preset')] || '';});
    });

    $('naics').addEventListener('input', (e)=>{
      const t = e.target.value.toLowerCase();
      if (/^\d{4}/.test(t)) return;
      const map = [
        {k:['restaurant','food service','dining'], v:'7225 — Restaurants'},
        {k:['homebuilding','residential build','construction'], v:'2361 — Residential Building Construction'},
        {k:['steel','metal','mill'], v:'3311 — Iron & Steel Mills'},
        {k:['physician','clinic','doctor'], v:'6211 — Offices of Physicians'},
        {k:['aerospace','aircraft'], v:'3364 — Aerospace Product & Parts'}
      ];
      const hit = map.find(x=>x.k.some(w=>t.includes(w)));
      if (hit) e.target.value = hit.v;
    });

    const runBtn = $('run'), statusEl = $('status');
    runBtn.addEventListener('click', async () => {
      statusEl.textContent = 'Running forecast…';
      runBtn.disabled = true;

      const naicsRaw = $('naics').value.trim();
      const naics = naicsRaw.match(/^\d{4}/)?.[0] || naicsRaw;

      const payload = {
        event: $('event').value.trim(),
        geo: $('geo').value.trim(),
        naics,
        horizon: $('horizon').value,
        scenario: $('scenario').value,
        extra_factors: $('factors').value.trim()
      };

      if (!payload.event || !payload.geo || !payload.naics) {
        statusEl.textContent = 'Please fill Event, City/Region, and Industry.';
        runBtn.disabled = false;
        return;
      }

      try {
        const res = await fetch('/api/forecast', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          const txt = await res.text().catch(()=> '');
          throw new Error(`API ${res.status}: ${txt || 'Request failed'}`);
        }

        const data = await res.json();
        renderForecast(data);
        statusEl.textContent = 'Done.';

        // Save to history (if signed in)
        await saveForecastToHistory(payload, data);

        // Increment usage (server or local fallback)
        await incrUsage();

        // Stash last result for CSV/PDF
        lastForecast = { payload, data, ts: new Date().toISOString() };
      } catch (e) {
        console.error(e);
        statusEl.textContent = e.message || 'Something went wrong.';
      } finally {
        runBtn.disabled = false;
      }
    });

    $('reset').addEventListener('click', () => {
      ['event','geo','naics','factors'].forEach(id=>$(id).value='');
      $('kpiDemand').textContent = '—';
      $('kpiCosts').textContent  = '—';
      $('kpiMargin').textContent = '—';
      $('drivers').innerHTML = '';
      $('conf').textContent = '';
      $('status').textContent = '';
      $('sourceBadge').style.display = 'none';
      $('showMore').checked = false;
      $('details').style.display = 'none';
      renderImpactChart({ demand_pct:0, cost_pct:0, margin_bps:0, time_path:[] });
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    // Show more toggle
    const showMore = document.getElementById('showMore');
    const details  = document.getElementById('details');
    showMore?.addEventListener('change', ()=> {
      details.style.display = showMore.checked ? 'block' : 'none';
    });

    // ====== RENDER FORECAST ======
    function renderForecast(data){
      $('kpiDemand').textContent = fmtPct(data?.demand_pct);
      $('kpiCosts').textContent  = fmtPct(data?.cost_pct);
      $('kpiMargin').textContent = (Number(data?.margin_bps) >= 0 ? '+' : '') + (data?.margin_bps ?? '0') + ' bps';

      const drivers = $('drivers');
      drivers.innerHTML = '';
      (data?.drivers || []).slice(0,6).forEach(d => {
        const li = document.createElement('li');
        li.textContent = '• ' + d.text;
        if (d.tone === 'good') li.className = 'good';
        if (d.tone === 'bad')  li.className = 'bad';
        if (d.tone === 'warn') li.className = 'warn';
        drivers.appendChild(li);
      });

      $('conf').textContent = 'Confidence: ' + Math.round((data?.confidence||0)*100) + '%';

      const src = data?.meta?.source;
      if (src) {
        const badge = $('sourceBadge');
        const label = src === 'openrouter' ? 'AI forecast (OpenRouter)' :
                      src === 'fallback-demo' ? 'Demo forecast (fallback)' :
                      String(src);
        badge.textContent = label;
        badge.style.display = 'inline-flex';
      }

      $('sum').textContent = data?.summary || '';
      fillList('assumptions', data?.assumptions);
      fillList('risks', data?.risks);
      fillList('signals', data?.local_signals);

      const tp = Array.isArray(data?.time_path) ? data.time_path : [];
      const tpathEl = $('tpath'); tpathEl.innerHTML = '';
      tp.forEach(x => {
        const li = document.createElement('li');
        li.textContent = `• ${x?.t || ''}: ${x?.note || ''}`;
        tpathEl.appendChild(li);
      });
      fillList('actions', data?.actions);

      const hasDetails = (data?.summary || tp.length || (data?.assumptions||[]).length ||
                          (data?.risks||[]).length || (data?.local_signals||[]).length ||
                          (data?.actions||[]).length);
      if (hasDetails) { showMore.checked = true; details.style.display = 'block'; }
      else            { showMore.checked = false; details.style.display = 'none'; }

      // Draw/update the chart
      renderImpactChart({
        demand_pct: data?.demand_pct,
        cost_pct: data?.cost_pct,
        margin_bps: data?.margin_bps,
        time_path: data?.time_path
      });
    }

    function fillList(id, arr) {
      const el = $(id); el.innerHTML = '';
      (arr || []).forEach(s => {
        const li = document.createElement('li');
        li.textContent = '• ' + s;
        el.appendChild(li);
      });
    }

    function fmtPct(x){
      if (x===undefined || x===null || isNaN(x)) return '—';
      const sign = x>0?'+':'';
      return sign + Number(x).toFixed(1) + '%';
    }

    // pricing toggle
    (function(){
      const toggle = document.getElementById('billing');
      const amounts = document.querySelectorAll('.nofa-price .amt');
      function setMode() {
        const annual = toggle.checked;
        amounts.forEach(el => {
          const m = el.getAttribute('data-month');
          const a = el.getAttribute('data-annual') || m;
          el.textContent = annual ? a : m;
        });
      }
      toggle.addEventListener('change', setMode);
      setMode();
    })();

    // ---- History API helpers (server save; UI reads via realtime listener) ----
    async function saveForecastToHistory(payload, result) {
      const token = await getIdToken();
      if (!token) return; // skip if not signed in
      const res = await fetch('/api/history/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify({ payload, result })
      });
      if (res.status === 402) {
        const msg = await res.json().catch(()=>({error:'Quota exceeded'}));
        alert(msg.error || 'Quota exceeded');
      }
    }

    function tsToDate(ts){
      if (!ts) return new Date();
      if (typeof ts === 'string' || ts instanceof String) return new Date(ts);
      if (typeof ts === 'number') return new Date(ts);
      if (ts._seconds) return new Date(ts._seconds * 1000);
      return new Date(ts);
    }
    function esc(s){ return (s||'').replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }

    // ===== Simple Canvas chart (no libs) =====
    function renderImpactChart({ demand_pct, cost_pct, margin_bps, time_path }) {
      const canvas = document.getElementById('chartImpact');
      const noteEl = document.getElementById('chartNote');
      if (!canvas) return;

      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      let labels = [];
      let demand = [];
      let cost = [];
      let margin = [];

      if (Array.isArray(time_path) && time_path.length) {
        labels = time_path.map(p => p.t || '');
        const n = time_path.length;
        const dm = Number(demand_pct || 0);
        const cs = Number(cost_pct || 0);
        const mb = Number(margin_bps || 0);
        for (let i = 1; i <= n; i++) {
          const f = i / n;
          demand.push((dm * f).toFixed(2));
          cost.push((cs * f).toFixed(2));
          margin.push(Math.round(mb * f));
        }
      } else {
        labels = ['Now', 'Mid', 'Later'];
        demand = [0, (Number(demand_pct||0)/2).toFixed(2), Number(demand_pct||0).toFixed(2)];
        cost   = [0, (Number(cost_pct||0)/2).toFixed(2), Number(cost_pct||0).toFixed(2)];
        margin = [0, Math.round(Number(margin_bps||0)/2), Math.round(Number(margin_bps||0))];
      }

      const P = { l: 42, r: 10, t: 10, b: 26 };
      const W = canvas.width - P.l - P.r;
      const H = canvas.height - P.t - P.b;

      const allY = [...demand, ...cost, ...margin].map(Number);
      const yMin = Math.min(...allY, 0);
      const yMax = Math.max(...allY, 0);
      const yPad = (yMax - yMin) * 0.15 || 1;
      const Y0 = yMin - yPad, Y1 = yMax + yPad;

      const xStep = W / Math.max(1, labels.length - 1);
      const yScale = (val) => H * (1 - (val - Y0) / (Y1 - Y0)) + P.t;

      // Axes
      ctx.strokeStyle = '#27315f';
      ctx.lineWidth = 1;
      ctx.beginPath(); ctx.moveTo(P.l, P.t); ctx.lineTo(P.l, P.t + H); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(P.l, P.t + H); ctx.lineTo(P.l + W, P.t + H); ctx.stroke();

      // Zero line
      if (Y0 < 0 && Y1 > 0) {
        const y0 = yScale(0);
        ctx.strokeStyle = '#33407a';
        ctx.setLineDash([4, 4]);
        ctx.beginPath(); ctx.moveTo(P.l, y0); ctx.lineTo(P.l + W, y0); ctx.stroke();
        ctx.setLineDash([]);
      }

      function drawSeries(values, color) {
        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        ctx.beginPath();
        values.forEach((v, i) => {
          const x = P.l + xStep * i;
          const y = yScale(Number(v));
          if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
        });
        ctx.stroke();
      }

      drawSeries(demand, '#6ea8fe'); // demand
      drawSeries(cost,   '#ffd60a'); // cost
      drawSeries(margin, '#35c759'); // margin bps

      // X labels
      ctx.fillStyle = '#aab3d9';
      ctx.font = '11px system-ui, -apple-system, Segoe UI, Arial';
      labels.forEach((lbl, i) => {
        const x = P.l + xStep * i;
        ctx.fillText(lbl, x - 10, P.t + H + 16);
      });

      // Legend
      const legend = [
        { k: 'Demand %', c: '#6ea8fe' },
        { k: 'Cost %',   c: '#ffd60a' },
        { k: 'Margin bps', c: '#35c759' }
      ];
      let lx = P.l, ly = P.t + 8;
      legend.forEach(item => {
        ctx.fillStyle = item.c; ctx.fillRect(lx, ly - 9, 12, 3);
        ctx.fillStyle = '#aab3d9'; ctx.fillText(item.k, lx + 16, ly);
        lx += 110;
      });

      if (noteEl) noteEl.textContent = 'Lines approximate trajectory based on time path and headline KPIs.';
    }

    // ===== CSV + PDF =====
    let lastForecast = null;

    document.getElementById('btnCsv').addEventListener('click', ()=>{
      if (!lastForecast || !lastForecast.data) { alert('Run a forecast first.'); return; }
      const { payload, data, ts } = lastForecast;
      const rows = [];
      rows.push(['Timestamp', ts]);
      rows.push(['Geo', payload.geo]);
      rows.push(['Industry', payload.naics]);
      rows.push(['Event', payload.event]);
      rows.push(['Horizon', payload.horizon]);
      rows.push(['Scenario', payload.scenario]);
      rows.push(['Extra Factors', payload.extra_factors]);
      rows.push([]);
      rows.push(['KPI','Value']);
      rows.push(['Demand %', data.demand_pct]);
      rows.push(['Cost %', data.cost_pct]);
      rows.push(['Margin (bps)', data.margin_bps]);
      rows.push(['Confidence', Math.round((data.confidence||0)*100)+'%']);
      rows.push([]);
      rows.push(['Summary', data.summary || '']);
      rows.push([]);
      rows.push(['Drivers']);
      (data.drivers||[]).forEach(d=>rows.push([d.tone, d.text]));
      rows.push([]);
      rows.push(['Assumptions']); (data.assumptions||[]).forEach(s=>rows.push([s]));
      rows.push([]);
      rows.push(['Risks']); (data.risks||[]).forEach(s=>rows.push([s]));
      rows.push([]);
      rows.push(['Local Signals']); (data.local_signals||[]).forEach(s=>rows.push([s]));
      rows.push([]);
      rows.push(['Time Path']);
      (data.time_path||[]).forEach(p=>rows.push([p.t, p.note]));
      rows.push([]);
      rows.push(['Actions']); (data.actions||[]).forEach(s=>rows.push([s]));

      const csv = rows.map(r => r.map(cell => `"${String(cell??'').replace(/"/g,'""')}"`).join(',')).join('\r\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const name = `EcoForecast_${payload.geo}_${payload.naics}_${new Date(ts).toISOString().slice(0,10)}.csv`.replace(/[^\w.\-]+/g,'_');
      const a = document.createElement('a'); a.href = url; a.download = name; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    });

    document.getElementById('btnPdf').addEventListener('click', ()=>{
      if (!lastForecast || !lastForecast.data) { alert('Run a forecast first.'); return; }
      const { payload, data, ts } = lastForecast;
      const win = window.open('', '_blank', 'noopener,noreferrer,width=900,height=1000');
      const style = `
        <style>
          body{font-family:Arial,Helvetica,sans-serif;color:#000;padding:24px}
          h1{margin:0 0 8px;font-size:20px}
          h2{margin:18px 0 8px;font-size:16px}
          .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:10px 0}
          .card{border:1px solid #ccc;border-radius:8px;padding:10px}
          ul{margin:6px 0 10px}
          .muted{color:#555;font-size:12px}
        </style>
      `;
      const html = `
        <h1>EcoForecast AI™ — Forecast Brief</h1>
        <div class="muted">Generated: ${new Date(ts).toLocaleString()}</div>
        <div class="card">
          <div><strong>Geo:</strong> ${esc(payload.geo)} &nbsp; <strong>Industry:</strong> ${esc(payload.naics)}</div>
          <div><strong>Event:</strong> ${esc(payload.event)}</div>
          <div><strong>Horizon:</strong> ${esc(payload.horizon)} &nbsp; <strong>Scenario:</strong> ${esc(payload.scenario)}</div>
          <div><strong>Extra:</strong> ${esc(payload.extra_factors || '')}</div>
        </div>
        <div class="kpi">
          <div class="card"><div>Demand</div><div><strong>${fmtPct(data.demand_pct)}</strong></div></div>
          <div class="card"><div>Costs</div><div><strong>${fmtPct(data.cost_pct)}</strong></div></div>
          <div class="card"><div>EBITDA Margin</div><div><strong>${(data.margin_bps>=0?'+':'')+data.margin_bps} bps</strong></div></div>
        </div>
        <h2>Summary</h2>
        <div class="card">${esc(data.summary || '')}</div>
        <h2>Drivers</h2>
        <div class="card"><ul>${(data.drivers||[]).map(d=>`<li>[${d.tone}] ${esc(d.text)}`).join('')}</ul></div>
        <h2>Assumptions</h2>
        <div class="card"><ul>${(data.assumptions||[]).map(s=>`<li>${esc(s)}`).join('')}</ul></div>
        <h2>Risks</h2>
        <div class="card"><ul>${(data.risks||[]).map(s=>`<li>${esc(s)}`).join('')}</ul></div>
        <h2>Local Signals</h2>
        <div class="card"><ul>${(data.local_signals||[]).map(s=>`<li>${esc(s)}`).join('')}</ul></div>
        <h2>Time Path</h2>
        <div class="card"><ul>${(data.time_path||[]).map(p=>`<li>${esc(p.t||'')}: ${esc(p.note||'')}`).join('')}</ul></div>
        <h2>Actions</h2>
        <div class="card"><ul>${(data.actions||[]).map(s=>`<li>${esc(s)}`).join('')}</ul></div>
        <div class="muted">Source: ${esc(data?.meta?.source || '')}</div>
        <script>window.onload=()=>setTimeout(()=>window.print(),250)</script>
      `;
      win.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>EcoForecast Brief</title>${style}</head><body>${html}</body></html>`);
      win.document.close();
    });

  </script>
</body>
</html>
