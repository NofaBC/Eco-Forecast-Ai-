<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EcoForecast AI™ — Event-to-Economy Forecaster</title>
  <meta name="description" content="Forecast the local economic impact of wars, market shocks, weather, regime changes, and new policies on cities and businesses." />
  <style>
    :root { --bg:#0b1020; --card:#121a35; --edge:#1c254b; --text:#e8ecff; --muted:#aab3d9; --accent:#6ea8fe; --good:#35c759; --bad:#ff453a; --warn:#ffd60a; }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial;background:linear-gradient(180deg,#0b1020,#0a0f1c);color:var(--text)}
    a{color:var(--accent); text-decoration:none}
    header{padding:28px 20px;border-bottom:1px solid var(--edge);background:rgba(10,15,28,.6);backdrop-filter:saturate(1.2) blur(8px);position:sticky;top:0;z-index:20}
    .wrap{max-width:1080px;margin:0 auto}
    .flex{display:flex;gap:14px;align-items:center;justify-content:space-between}
    h1{margin:0;font-size:22px;letter-spacing:.3px}
    .tag{display:inline-block;margin-top:8px;padding:4px 10px;border:1px solid #263064;border-radius:999px;color:var(--muted);font-size:12px}
    main{padding:26px 20px}

    /* Hero */
    .hero{display:grid;grid-template-columns:1.1fr .9fr;gap:20px;margin-bottom:18px}
    .hero-card{background:var(--card);border:1px solid var(--edge);border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .hero h2{margin:0 0 10px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid #2a3567;color:var(--muted);font-size:12px}

    /* Form */
    label{display:block;font-size:13px;color:var(--muted);margin:10px 0 4px}
    input,select,textarea{width:100%;padding:12px 12px;border-radius:12px;border:1px solid #27315f;background:#0e1530;color:var(--text);outline:none}
    textarea{min-height:100px;resize:vertical}
    button{padding:14px 16px;border-radius:12px;border:1px solid #33407a;background:linear-gradient(180deg,#2741b3,#1f2d80);color:white;font-weight:600;cursor:pointer}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .chip{border:1px solid #2a3567;background:#0e1530;padding:6px 10px;border-radius:999px;font-size:12px;cursor:pointer}

    /* Results */
    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:8px}
    .kpi .v{font-size:22px;font-weight:700}
    .kpi .u{font-size:12px;color:var(--muted)}
    .drivers{list-style:none;padding:0;margin:0}
    .drivers li{margin:6px 0}
    .good{color:var(--good)} .bad{color:var(--bad)} .warn{color:var(--warn)}
    .src-badge{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--edge);border-radius:999px;padding:4px 10px;font-size:11px;color:var(--muted);margin-top:10px}

    /* Pricing */
    .pricing{margin-top:32px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
    .card{background:var(--card);border:1px solid var(--edge);border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.25)}

    /* Pricing table */
    .nofa-pricing{background:linear-gradient(180deg,#0b1020,#0a0f1c);color:var(--text);padding:8px 0}
    .nofa-wrap{max-width:1100px;margin:0 auto}
    .nofa-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:18px}
    .nofa-card{background:var(--card);border:1px solid var(--edge);border-radius:16px;padding:20px;display:flex;flex-direction:column;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .nofa-badge{display:inline-flex;gap:6px;align-items:center;font-size:12px;color:var(--muted);border:1px solid var(--edge);border-radius:999px;padding:4px 10px;margin-bottom:10px}
    .nofa-title{font-size:18px;font-weight:700;margin:0 0 6px}
    .nofa-sub{font-size:13px;color:var(--muted);margin:0 0 12px}
    .nofa-price{display:flex;align-items:flex-end;gap:6px;margin:6px 0 12px}
    .nofa-price .amt{font-size:28px;font-weight:800}
    .nofa-price .unit{font-size:13px;color:var(--muted)}
    .nofa-setup{font-size:12px;color:var(--warn);margin:-4px 0 10px}
    .nofa-cta{margin-top:auto;display:flex;flex-direction:column;gap:10px}
    .nofa-cta a{display:inline-block;text-align:center;color:white;font-weight:700;padding:12px 14px;border-radius:12px;border:1px solid #32407a;background:linear-gradient(180deg,#2741b3,#1f2d80)}
    .nofa-cta a.secondary{background:#0f1630}
    .nofa-features{list-style:none;padding:0;margin:12px 0 0;display:grid;gap:8px;font-size:14px}
    .strike{color:var(--muted);text-decoration:line-through}
    .save-tag{font-size:11px;color:var(--good);border:1px solid rgba(53,199,89,.35);border-radius:999px;padding:2px 8px;margin-left:6px}
    .toggleRow{display:flex;align-items:center;gap:10px;margin:10px 0 20px;color:var(--muted);font-size:13px}
    .switch{position:relative;width:48px;height:26px;background:#0f1630;border:1px solid var(--edge);border-radius:999px;cursor:pointer}
    .switch i{position:absolute;top:2px;left:2px;width:20px;height:20px;border-radius:50%;background:var(--accent);transition:transform .2s}
    input#billing:checked + .switch i{transform:translateX(22px)}

    .badge-available, .badge-soon { display:inline-flex; align-items:center; gap:6px; font-size:11px; padding:3px 8px; border-radius:999px; border:1px solid var(--edge); }
    .badge-available { color: var(--good); border-color: rgba(53,199,89,.5); }
    .badge-soon { color: var(--warn); border-color: rgba(255,214,10,.45); }
    .avail.live { color: var(--good); }
    .avail.soon { color: var(--warn); }
    .cta-disabled { opacity:.6; cursor:not-allowed; }

    /* Account dropdown */
    .account{position:relative; display:inline-block}
    .account-btn{cursor:pointer; padding:8px 10px; border:1px solid var(--edge); border-radius:10px; color:var(--text); background:#0f1630;}
    .account-menu{position:absolute; right:0; top:42px; min-width:220px; display:none; background:var(--card); border:1px solid var(--edge); border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.35); padding:6px}
    .account-menu.open{display:block}
    .account-menu a, .account-menu button{display:block; width:100%; text-align:left; background:transparent; border:0; color:var(--text); padding:10px 12px; border-radius:8px; cursor:pointer}
    .account-menu a:hover, .account-menu button:hover{background:#0f1630}

    /* History modal */
    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.5); z-index:50}
    .modal.open{display:flex}
    .modal-card{width:min(720px,92vw); max-height:80vh; overflow:auto; background:var(--card); border:1px solid var(--edge); border-radius:16px; padding:16px}
    .modal-card h3{margin:0 0 8px}
    .hist-item{padding:10px 0; border-bottom:1px dashed #27315f; font-size:14px}
    .hist-item:last-child{border-bottom:none}

    @media (max-width:980px){
      .hero{grid-template-columns:1fr}
      .grid{grid-template-columns:1fr}
      .nofa-grid{grid-template-columns:1fr}
    }
  </style>

  <!-- Firebase (compat builds) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <!-- Optional: Analytics -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics-compat.js"></script>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="flex">
        <div>
          <h1>EcoForecast AI™</h1>
          <div class="tag">Turn events into city & business forecasts — in seconds</div>
        </div>
        <nav aria-label="top">
          <a href="#forecast">Forecast</a>
          &nbsp;·&nbsp;
          <a href="#pricing">Pricing</a>
          &nbsp;·&nbsp;
          <!-- Account -->
          <span class="account">
            <button id="accountBtn" class="account-btn">Sign In</button>
            <div id="accountMenu" class="account-menu" role="menu" aria-label="Account menu"></div>
          </span>
        </nav>
      </div>
    </div>
  </header>

  <main class="wrap" id="forecast">
    <section class="hero">
      <!-- Left: Form -->
      <section class="hero-card" aria-labelledby="form-title">
        <h2 id="form-title">Forecast an Impact</h2>
        <p class="pill">Step 1 · Describe the event or paste a bill / EO summary</p>

        <label for="event">Event / Policy</label>
        <textarea id="event" placeholder="Example: 'U.S. imposes 10% tariff on aluminum; expected start in 60 days' OR paste a bill/EO text."></textarea>

        <div class="chips" aria-label="Event presets">
          <button class="chip" data-preset="war_escalation">War Escalation</button>
          <button class="chip" data-preset="tariff_steel">10% Steel Tariff</button>
          <button class="chip" data-preset="hurricane_landfall">Hurricane Landfall</button>
          <button class="chip" data-preset="regime_change">Regime Change</button>
          <button class="chip" data-preset="party_shift_us">US Party Shift</button>
        </div>

        <div class="row">
          <div>
            <label for="geo">City / Region</label>
            <input id="geo" placeholder="e.g., Potomac, MD or Phoenix, AZ" list="geo-suggest" />
            <datalist id="geo-suggest">
              <option value="Phoenix, AZ"></option>
              <option value="Potomac, MD"></option>
              <option value="New York, NY"></option>
              <option value="Miami, FL"></option>
              <option value="Houston, TX"></option>
            </datalist>
          </div>
          <div>
            <label for="naics">Industry (NAICS or keyword)</label>
            <input id="naics" placeholder="e.g., 7225 (Restaurants) or 'Homebuilding'" list="naics-suggest" />
            <datalist id="naics-suggest">
              <option value="7225 — Restaurants"></option>
              <option value="2361 — Residential Building Construction"></option>
              <option value="3364 — Aerospace Product & Parts"></option>
              <option value="4238 — Machinery, Equipment & Supplies Wholesalers"></option>
              <option value="6211 — Offices of Physicians"></option>
            </datalist>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="horizon">Horizon</label>
            <select id="horizon">
              <option value="short">0–3 months</option>
              <option value="medium" selected>3–12 months</option>
              <option value="long">12–24 months</option>
            </select>
          </div>
          <div>
            <label for="scenario">Scenario</label>
            <select id="scenario">
              <option>Base</option>
              <option>Best Case</option>
              <option>Severe</option>
            </select>
          </div>
        </div>

        <label for="factors">(Optional) Extra factors to include</label>
        <input id="factors" placeholder="wars, stock volatility, weather alerts, regime changes, party control…" />

        <div style="margin-top:14px;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <button id="run">Run Forecast</button>
          <button id="reset" class="secondary" style="background:#0f1630;border:1px solid var(--edge);color:var(--text)">Reset</button>
          <span id="status" style="color:var(--muted)"></span>
        </div>
      </section>

      <!-- Right: Results -->
      <section class="hero-card" aria-labelledby="results-title">
        <h2 id="results-title">Results</h2>
        <div id="results" style="min-height:260px">
          <p class="pill">Your forecast will appear here with drivers & confidence.</p>
          <div class="kpi" aria-live="polite">
            <div><div class="u">Demand</div><div id="kpiDemand" class="v">—</div></div>
            <div><div class="u">Costs</div><div id="kpiCosts" class="v">—</div></div>
            <div><div class="u">EBITDA Margin</div><div id="kpiMargin" class="v">—</div></div>
          </div>
          <h3 style="margin:14px 0 6px">Top Drivers</h3>
          <ul id="drivers" class="drivers"></ul>
          <p id="conf" class="u" style="margin-top:8px"></p>
          <div id="sourceBadge" class="src-badge" style="display:none"></div>

          <!-- NEW: Show more details toggle + content -->
          <div id="moreSwitch" style="margin-top:10px">
            <label style="font-size:12px;color:var(--muted);display:flex;gap:8px;align-items:center">
              <input type="checkbox" id="showMore">
              Show more details
            </label>
          </div>

          <div id="details" style="display:none; margin-top:10px">
            <p id="sum" style="margin:6px 0"></p>
            <h4 style="margin:10px 0 4px">Assumptions</h4>
            <ul id="assumptions" class="drivers"></ul>
            <h4 style="margin:10px 0 4px">Risks</h4>
            <ul id="risks" class="drivers"></ul>
            <h4 style="margin:10px 0 4px">Local Signals</h4>
            <ul id="signals" class="drivers"></ul>
            <h4 style="margin:10px 0 4px">Time Path</h4>
            <ul id="tpath" class="drivers"></ul>
            <h4 style="margin:10px 0 4px">Suggested Actions</h4>
            <ul id="actions" class="drivers"></ul>
          </div>
        </div>
      </section>
    </section>

    <!-- Pricing Section -->
    <section id="pricing" class="pricing" aria-labelledby="pricing-title">
      <h2 id="pricing-title" style="margin:0 0 12px">Pricing & Onboarding</h2>
      <section class="nofa-pricing" aria-labelledby="pricing-h">
        <div class="nofa-wrap">
          <h3 id="pricing-h" class="nofa-sub" style="margin:0 0 8px">EcoForecast AI™ Plans</h3>

          <p class="nofa-sub" style="margin:6px 0 14px">
            <strong>Note:</strong> We’re in <em>Demo+</em>. <span class="avail.live">Business Insight is available now</span>.
            <span class="avail soon">Analyst Pro</span> and <span class="avail soon">Enterprise</span> are coming soon.
          </p>

          <label class="toggleRow" for="billing">
            <span>Bill monthly</span>
            <input id="billing" type="checkbox" hidden>
            <span class="switch" aria-hidden="true"><i></i></span>
            <span>Bill annually <span class="save-tag">save ~15% + setup waivers*</span></span>
          </label>

          <div class="nofa-grid" role="list">
            <!-- Business Insight -->
            <article class="nofa-card" role="listitem" aria-label="Business Insight plan">
              <span class="nofa-badge">EcoForecast AI™</span>
              <h4 class="nofa-title">Business Insight</h4>
              <p class="nofa-sub">Localized forecasts for SMBs (city + industry).</p>
              <div class="nofa-price"><span class="amt" data-month="$197/mo" data-annual="$167/mo">$197/mo</span><span class="unit">USD</span></div>
              <div class="nofa-setup">Setup: <strong>Optional $250</strong> (waived on annual)</div>
              <p><span class="badge-available">Available Now</span></p>
              <ul class="nofa-features">
                <li>10 forecasts/month</li>
                <li>Drivers & confidence</li>
                <li>Downloadable briefs</li>
                <li class="strike">Scenario Studio</li>
              </ul>
              <div class="nofa-cta">
                <a href="#" onclick="return sendEmail('info@nofabusinessconsulting.com','EcoForecast AI — Start Business Insight (beta)', T_BIZ);" aria-label="Start Business Insight (beta)">Get Started (Beta)</a>
                <a class="secondary" href="#" onclick="return sendEmail('info@nofabusinessconsulting.com','EcoForecast AI — Book a Demo', T_DEMO);" aria-label="Book a demo">Book a Demo</a>
                <a class="secondary" href="#" onclick="copyEmail('info@nofabusinessconsulting.com'); return false;" aria-label="Copy email address">Copy Email</a>
              </div>
            </article>

            <!-- Analyst Pro -->
            <article class="nofa-card" role="listitem" aria-label="Analyst Pro plan">
              <span class="nofa-badge">EcoForecast AI™</span>
              <h4 class="nofa-title">Analyst Pro</h4>
              <p class="nofa-sub">Quantified city & industry forecasts with scenarios.</p>
              <div class="nofa-price"><span class="amt" data-month="$697/mo" data-annual="$592/mo">$697/mo</span><span class="unit">USD</span></div>
              <div class="nofa-setup">Setup: <strong>$1,000</strong> (local datasets + calibration)</div>
              <p><span class="badge-soon">Coming Soon</span></p>
              <ul class="nofa-features">
                <li>Unlimited forecasts</li>
                <li>Scenario Studio (best/base/severe)</li>
                <li>Alerts (impact thresholds)</li>
                <li>City & NAICS localization</li>
              </ul>
              <div class="nofa-cta">
                <a class="secondary" href="#" onclick="return sendEmail('waitlist_ai@nofabusinessconsulting.com','Join Waitlist — Analyst Pro (please specify AI solution)', T_WAITLIST_ANALYST);" aria-label="Join waitlist for Analyst Pro">Join Waitlist</a>
                <a class="secondary" href="#" onclick="copyEmail('waitlist_ai@nofabusinessconsulting.com'); return false;" aria-label="Copy waitlist email">Copy Email</a>
                <a class="cta-disabled" aria-disabled="true" tabindex="-1" href="#" title="Purchasing opens when Analyst Pro launches">Purchase (Soon)</a>
              </div>
            </article>

            <!-- Enterprise -->
            <article class="nofa-card" role="listitem" aria-label="Enterprise plan">
              <span class="nofa-badge">EcoForecast AI™</span>
              <h4 class="nofa-title">Enterprise / Investor</h4>
              <p class="nofa-sub">Custom models, API & BI integrations, white-glove onboarding.</p>
              <div class="nofa-price"><span class="amt" data-month="$5,000+/mo" data-annual="$4,250+/mo">$5,000+/mo</span><span class="unit">USD</span></div>
              <div class="nofa-setup">Setup: <strong>$10,000</strong> (scope-dependent)</div>
              <p><span class="badge-soon">Pilot / Coming Soon</span></p>
              <ul class="nofa-features">
                <li>Custom model tuning</li>
                <li>API & data pipelines</li>
                <li>Backtesting & validation</li>
                <li>Priority support</li>
              </ul>
              <div class="nofa-cta">
                <a href="#" onclick="return sendEmail('info@nofabusinessconsulting.com','EcoForecast AI — Enterprise Pilot', T_ENTERPRISE);" aria-label="Contact sales for Enterprise pilot">Contact Sales</a>
                <a class="secondary" href="#" onclick="return sendEmail('waitlist_ai@nofabusinessconsulting.com','Join Waitlist — Enterprise (please specify AI solution)', T_WAITLIST_ANALYST);" aria-label="Join Enterprise waitlist">Join Waitlist</a>
                <a class="secondary" href="#" onclick="copyEmail('waitlist_ai@nofabusinessconsulting.com'); return false;" aria-label="Copy waitlist email">Copy Email</a>
              </div>
            </article>
          </div>
        </div>
      </section>
    </section>
  </main>

  <footer class="wrap" style="padding:28px 20px;color:var(--muted);font-size:13px">
    © EcoForecast AI™ • Part of the GovFlow AI™ family • For demo use only — not investment advice.
  </footer>

  <!-- History modal -->
  <div id="histModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="histTitle">
    <div class="modal-card">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
        <h3 id="histTitle">My Forecast History</h3>
        <button id="histClose" class="account-btn" style="padding:6px 10px">Close</button>
      </div>
      <div id="histBody"></div>
    </div>
  </div>

  <!-- Email helpers -->
  <script>
    function sendEmail(address, subject, template) {
      if (template) { (navigator.clipboard?.writeText(template).catch(()=>{})); }
      const s = encodeURIComponent(subject || '');
      window.location.href = `mailto:${address}?subject=${s}`;
      if (template) setTimeout(()=>alert('Template copied. If your mail body is empty, press Ctrl+V to paste.'), 300);
      return false;
    }
    function copyEmail(email) {
      (navigator.clipboard?.writeText(email).then(()=>alert(`Email copied: ${email}`)).catch(()=>legacyCopy(email)));
    }
    function legacyCopy(text){
      const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta);
      ta.select(); document.execCommand('copy'); document.body.removeChild(ta); alert(`Email copied: ${text}`);
    }
    const T_BIZ = ['Hi NOFA Team,','','We would like to start the Business Insight plan (EcoForecast AI).','Company:','City/Region:','Industry (NAICS):','Use cases:','Timeline:','','Thanks!'].join('\n');
    const T_DEMO = ['Hi NOFA Team,','','Please book me for a demo of EcoForecast AI.','Company:','Preferred time zones/slots:',''].join('\n');
    const T_WAITLIST_ANALYST = ['Hi NOFA Team,','','Please add me to the waitlist.','Interested AI solution: EcoForecast AI / GovFlow AI / Other (please specify)','Company:','Role:','City/Region:','Use cases:','Timeline:',''].join('\n');
    const T_ENTERPRISE = ['Hi NOFA Team,','','We’re interested in an Enterprise pilot.','Interested AI solution: EcoForecast AI / GovFlow AI / Other (please specify)','Company:','Use cases:','Integrations (BI, API, data sources):','Timeline:',''].join('\n');
  </script>

  <!-- App + Auth + History -->
  <script>
    // ==== Firebase init (YOUR config) ====
    const firebaseConfig = {
      apiKey: "AIzaSyBBfrQcMn5Hmt2H5EbMh06LHmbCvtUZrU8",
      authDomain: "eco-forecast-ai.firebaseapp.com",
      projectId: "eco-forecast-ai",
      storageBucket: "eco-forecast-ai.firebasestorage.app",
      messagingSenderId: "133605292809",
      appId: "1:133605292809:web:681c3eb8beb4d2a506b1d8",
      measurementId: "G-XR5KV7MY16"
    };
    firebase.initializeApp(firebaseConfig);
    if (firebase.analytics) { firebase.analytics(); }

    const $ = id => document.getElementById(id);

    // ---- Account dropdown ----
    const accountBtn = $('accountBtn');
    const accountMenu = $('accountMenu');
    const histModal = $('histModal');
    const histBody = $('histBody');
    const histClose = $('histClose');

    accountBtn.addEventListener('click', () => {
      accountMenu.classList.toggle('open');
    });
    document.addEventListener('click', (e)=>{
      if (!accountMenu.contains(e.target) && !accountBtn.contains(e.target)) {
        accountMenu.classList.remove('open');
      }
    });
    histClose.addEventListener('click', ()=> histModal.classList.remove('open'));
    histModal.addEventListener('click', (e)=>{ if (e.target===histModal) histModal.classList.remove('open'); });

    async function signInWithGoogle() {
      const provider = new firebase.auth.GoogleAuthProvider();
      try {
        // redirect is the most reliable across browsers
        await firebase.auth().signInWithRedirect(provider);
      } catch (err) {
        alert('Google sign-in failed: ' + (err.message || err.code));
        console.error(err);
      }
    }
    async function signInWithEmailPrompt() {
      const email = prompt('Email:');
      if (!email) return;
      const password = prompt('Create or enter your password (min 6 chars):');
      if (!password) return;
      try {
        await firebase.auth().createUserWithEmailAndPassword(email, password);
      } catch (err) {
        if (err.code === 'auth/email-already-in-use') {
          await firebase.auth().signInWithEmailAndPassword(email, password);
        } else {
          alert('Email sign-in failed: ' + (err.message || err.code));
          console.error(err);
        }
      }
    }
    async function signOutNow(){ await firebase.auth().signOut(); }
    async function getIdToken(){
      const u = firebase.auth().currentUser;
      return u ? u.getIdToken() : null;
    }

    function renderMenu(user){
      accountMenu.innerHTML = '';
      if (!user) {
        const btnGoogle = document.createElement('button');
        btnGoogle.textContent = 'Sign in with Google';
        btnGoogle.onclick = async () => { await signInWithGoogle(); accountMenu.classList.remove('open'); };

        const btnEmail = document.createElement('button');
        btnEmail.textContent = 'Sign in with Email';
        btnEmail.onclick = async () => { await signInWithEmailPrompt(); accountMenu.classList.remove('open'); };

        accountMenu.append(btnGoogle, btnEmail);
        accountBtn.textContent = 'Sign In';
        return;
      }
      const lab = document.createElement('div');
      lab.style.cssText='padding:8px 12px;color:var(--muted);font-size:12px';
      lab.textContent = user.email;

      const viewHist = document.createElement('button');
      viewHist.textContent = 'View Forecast History';
      viewHist.onclick = async ()=>{
        accountMenu.classList.remove('open');
        const items = await loadHistory();
        histBody.innerHTML = items.length? '' : '<p class="nofa-sub">No history yet.</p>';
        items.forEach(it=>{
          const d = tsToDate(it.ts);
          const el = document.createElement('div');
          el.className = 'hist-item';
          el.innerHTML = `<div style="color:var(--muted);font-size:12px">${d.toLocaleString()}</div>
                          <div><strong>${esc(it?.payload?.geo||'')}</strong> · ${esc(it?.payload?.naics||'')}</div>
                          <div style="color:var(--muted)">${esc((it?.payload?.event||'').slice(0,180))}</div>`;
          histBody.appendChild(el);
        });
        histModal.classList.add('open');
      };

      const signOut = document.createElement('button');
      signOut.textContent = 'Sign Out';
      signOut.onclick = async ()=>{ await signOutNow(); accountMenu.classList.remove('open'); };

      accountMenu.append(lab, viewHist, signOut);
      accountBtn.textContent = `${user.email} ▾`;
    }
    firebase.auth().onAuthStateChanged(renderMenu);

    // ---- Forecast UI ----
    const presetsMap = {
      war_escalation: "A regional conflict escalates with partial blockade of a key shipping lane; insurance premia rise; export controls expand.",
      tariff_steel: "U.S. imposes a 10% tariff on steel imports effective in 60 days; exemptions uncertain; domestic mills signal capacity strain.",
      hurricane_landfall: "Category-4 hurricane landfall near major Gulf port; refinery throughput reduced; logistics reroutes extend lead times by 2-4 weeks.",
      regime_change: "Sudden regime change triggers capital controls and export permit reviews; FX volatility spikes; counterparties reassess risk.",
      party_shift_us: "One party gains unified control of White House and Congress; agenda prioritizes tax, energy, and labor policy changes within 12 months."
    };
    document.querySelectorAll('.chip').forEach(btn=>{
      btn.addEventListener('click',()=>{$('event').value = presetsMap[btn.getAttribute('data-preset')] || '';});
    });

    $('naics').addEventListener('input', (e)=>{
      const t = e.target.value.toLowerCase();
      if (/^\d{4}/.test(t)) return;
      const map = [
        {k:['restaurant','food service','dining'], v:'7225 — Restaurants'},
        {k:['homebuilding','residential build','construction'], v:'2361 — Residential Building Construction'},
        {k:['steel','metal','mill'], v:'3311 — Iron & Steel Mills'},
        {k:['physician','clinic','doctor'], v:'6211 — Offices of Physicians'},
        {k:['aerospace','aircraft'], v:'3364 — Aerospace Product & Parts'}
      ];
      const hit = map.find(x=>x.k.some(w=>t.includes(w)));
      if (hit) e.target.value = hit.v;
    });

    const runBtn = $('run'), statusEl = $('status');
    runBtn.addEventListener('click', async () => {
      statusEl.textContent = 'Running forecast…';
      runBtn.disabled = true;

      const naicsRaw = $('naics').value.trim();
      const naics = naicsRaw.match(/^\d{4}/)?.[0] || naicsRaw;

      const payload = {
        event: $('event').value.trim(),
        geo: $('geo').value.trim(),
        naics,
        horizon: $('horizon').value,
        scenario: $('scenario').value,
        extra_factors: $('factors').value.trim()
      };

      if (!payload.event || !payload.geo || !payload.naics) {
        statusEl.textContent = 'Please fill Event, City/Region, and Industry.';
        runBtn.disabled = false;
        return;
      }

      try {
        const res = await fetch('/api/forecast', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          const txt = await res.text().catch(()=> '');
          throw new Error(`API ${res.status}: ${txt || 'Request failed'}`);
        }

        const data = await res.json();
        renderForecast(data);
        statusEl.textContent = 'Done.';

        // Save to history (if signed in)
        await saveForecastToHistory(payload, data);
      } catch (e) {
        console.error(e);
        statusEl.textContent = e.message || 'Something went wrong.';
      } finally {
        runBtn.disabled = false;
      }
    });

    $('reset').addEventListener('click', () => {
      ['event','geo','naics','factors'].forEach(id=>$(id).value='');
      $('kpiDemand').textContent = '—';
      $('kpiCosts').textContent  = '—';
      $('kpiMargin').textContent = '—';
      $('drivers').innerHTML = '';
      $('conf').textContent = '';
      $('status').textContent = '';
      $('sourceBadge').style.display = 'none';
      $('showMore').checked = false;
      $('details').style.display = 'none';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    // NEW: toggle show more details
    const showMore = document.getElementById('showMore');
    const details  = document.getElementById('details');
    showMore?.addEventListener('change', ()=> {
      details.style.display = showMore.checked ? 'block' : 'none';
    });

    function renderForecast(data){
      $('kpiDemand').textContent = fmtPct(data?.demand_pct);
      $('kpiCosts').textContent  = fmtPct(data?.cost_pct);
      $('kpiMargin').textContent = (Number(data?.margin_bps) >= 0 ? '+' : '') + (data?.margin_bps ?? '0') + ' bps';

      const drivers = $('drivers');
      drivers.innerHTML = '';
      (data?.drivers || []).slice(0,6).forEach(d => {
        const li = document.createElement('li');
        li.textContent = '• ' + d.text;
        if (d.tone === 'good') li.className = 'good';
        if (d.tone === 'bad')  li.className = 'bad';
        if (d.tone === 'warn') li.className = 'warn';
        drivers.appendChild(li);
      });

      $('conf').textContent = 'Confidence: ' + Math.round((data?.confidence||0)*100) + '%';

      const src = data?.meta?.source;
      if (src) {
        const badge = $('sourceBadge');
        const label = src === 'openrouter' ? 'AI forecast (OpenRouter)' :
                      src === 'fallback-demo' ? 'Demo forecast (fallback)' :
                      String(src);
        badge.textContent = label;
        badge.style.display = 'inline-flex';
      }

      // NEW: render details if present
      $('sum').textContent = data?.summary || '';
      fillList('assumptions', data?.assumptions);
      fillList('risks', data?.risks);
      fillList('signals', data?.local_signals);

      const tp = Array.isArray(data?.time_path) ? data.time_path : [];
      const tpathEl = $('tpath'); tpathEl.innerHTML = '';
      tp.forEach(x => {
        const li = document.createElement('li');
        li.textContent = `• ${x?.t || ''}: ${x?.note || ''}`;
        tpathEl.appendChild(li);
      });

      fillList('actions', data?.actions);

      const hasDetails = (data?.summary || tp.length || (data?.assumptions||[]).length ||
                          (data?.risks||[]).length || (data?.local_signals||[]).length ||
                          (data?.actions||[]).length);
      if (hasDetails) { showMore.checked = true; details.style.display = 'block'; }
      else            { showMore.checked = false; details.style.display = 'none'; }
    }

    function fillList(id, arr) {
      const el = $(id); el.innerHTML = '';
      (arr || []).forEach(s => {
        const li = document.createElement('li');
        li.textContent = '• ' + s;
        el.appendChild(li);
      });
    }

    function fmtPct(x){
      if (x===undefined || x===null || isNaN(x)) return '—';
      const sign = x>0?'+':'';
      return sign + Number(x).toFixed(1) + '%';
    }

    // pricing toggle
    (function(){
      const toggle = document.getElementById('billing');
      const amounts = document.querySelectorAll('.nofa-price .amt');
      function setMode() {
        const annual = toggle.checked;
        amounts.forEach(el => {
          const m = el.getAttribute('data-month');
          const a = el.getAttribute('data-annual') || m;
          el.textContent = annual ? a : m;
        });
      }
      toggle.addEventListener('change', setMode);
      setMode();
    })();

    // ---- History API helpers ----
    async function saveForecastToHistory(payload, result) {
      const token = await getIdToken();
      if (!token) return; // skip if not signed in
      const res = await fetch('/api/history/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify({ payload, result })
      });
      if (res.status === 402) {
        const msg = await res.json().catch(()=>({error:'Quota exceeded'}));
        alert(msg.error || 'Quota exceeded');
      }
    }

    async function loadHistory() {
      const token = await getIdToken();
      if (!token) { alert('Please sign in to view your history.'); return []; }
      const res = await fetch('/api/history/list', { headers: { 'Authorization': `Bearer ${token}` } });
      if (!res.ok) return [];
      const data = await res.json();
      return (data.items || []).map(x => ({...x, ts: x.ts}));
    }

    function tsToDate(ts){
      if (!ts) return new Date();
      if (typeof ts === 'string' || ts instanceof String) return new Date(ts);
      if (typeof ts === 'number') return new Date(ts);
      if (ts._seconds) return new Date(ts._seconds * 1000);
      return new Date(ts);
    }
    function esc(s){ return (s||'').replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }
  </script>
</body>
</html>
